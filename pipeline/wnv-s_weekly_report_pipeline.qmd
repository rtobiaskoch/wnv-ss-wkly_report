---
title: "wnv-s_weekly_reports"
format: html
editor: visual
---

# Weekly Data Report

### 0 ---------------------------------- CONFIGURATION --------------------------------------------------

-   clears environment\
-   unloads packages\
-   loads necessary packages\
-   defines filepaths\
-   creates setting for plots

### INPUT

NONE

```{bash}
Rscript ../config/config_weekly.R --input ../test --year 2025 --week 23 --cp_threshold 500 --update F --clean F # first arg is year second is week
#add input dir arg 
#allows to easily run diff input folders
```

```{r}
rm(list = ls())
getwd()

source("../config/load_packages.R")

utils = list.files(path = "../utils",
                   pattern = "*.R",
                   full.names = T)

purrr::walk(utils, source)

#get the most recent configuration for the run from the output of running config_weekly.R
read_latest("../config/config_weekly_output")


```

```{bash}
#git commit -a -m "weekly commit before data removal"
#git push

```

```{r, echo=FALSE, eval=TRUE}

if(clean) {
   
    clean_dir(dir_mid)
    clean_dir(dir_output)
    
  } else {NULL}

```

### 0 ---------------------------DATA GDRIVE LOAD -----------------------------------------------

README: DESC: - reads in current wnv-s_database, foco_trap, and trap_malfunction data into the input folder

DEPENDENCIES: - googlesheets4 - googledrive - googledrive - argparse - source("0_R/gsheet_pull_prompt.R")

INPUT: - no input files loads them from googledrive

OUTPUT: - 1_input/wnv-s_database - data.csv - 1_input/foco_trap - data.csv - 1_input/trap\_ malfunction - data.csv

```{r}
if(update) {
#drive_download()
gsheet_pull_prompt(fn_key_rename, "Sheet1", key_rename_key)
gsheet_pull_prompt(fn_trap, "data", key_foco_trap)
gsheet_pull_prompt(fn_gdrive_database, "data", key_database_gsheet)
gsheet_pull_prompt(fn_standards, "data", key_standards_gsheet)

}

df_key_rename = read.csv(fn_key_rename)  
foco_trap = read.csv(fn_trap) %>% filter(active == 1)
database = read.csv(fn_gdrive_database)
standards = read.csv(fn_standards)
```

### 1 ---------------------------------DATASHEET CLEAN -----------------------------------------------

Readme DESC: - reads in datasheet (pool) data from VDCI and BC, - cleans it into the proper format for the database - checks each column for errors. -

DEPENDENCIES - gsheet_pull_prompt.R - tidyverse - purrr

INPUT: - 1_input/datasheets/ *-* yes/no prompts

OUTPUT: - 2_mid/\[fn_datasheet_clean\] (as defined in the config_weekly.R script)

```{r, datasheet_clean}
datasheet0 = read_list(dir_datasheet, "*")
saveRDS(datasheet0, fn_weekly_input_format_mid)

datasheet1 = datasheet0 %>%
  key_rename(rename_df = df_key_rename, 
             
             drop_extra = T)

datasheet = datasheet1 %>%
  wnv_s_clean()

#TO DO fix issue that the csu_id which is the key between the two is being cleaned so they dont match
#clean_changes = diffs_by_col(datasheet1, datasheet, names(datasheet1), "csu_id")
```



C H E C K  D A T A 
```{r}
#TO DO 
#make this a function

check_data(datasheet, #data you want to check
           foco_trap, #data with trap_ids you want to ensure trap is available
           year_filter, 
           week_filter)

```


All species
```{r}
#TO DO add 
all_spp0 = read_list(dir_all_spp, "*") 
all_spp = all_spp0 %>%
  key_rename(rename_df = df_key_rename,
             drop_extra = T) %>%
  wnv_s_clean()

```

Species Keep Culex
```{r}
all_spp_active = all_spp %>%
  filter(trap_id %in% foco_trap$trap_id)

missing_traps = check_data(all_spp_active, foco_trap, year_filter, week_filter)
write.csv(missing_traps, file.path(dir_mid, "missing_traps.csv"))

write.csv(all_spp, file.path(dir_mid, "all_species_active_trap.csv"))

abund0 = get_abund(all_spp_active, 
                  spp_keep = c("Pipiens", "Tarsalis"),
                  grp_var = c("zone", "year", "week", "spp"),
                  rm_zone = "BC")

write.csv(abund0$trap, file.path(dir_mid, "abund_trap.csv"))
write.csv(abund0$grp, file.path(dir_mid, "abund_grp.csv"))

#group FC
abund_fc = get_abund(all_spp_active, 
                  spp_keep = c("Pipiens", "Tarsalis"),
                  grp_var = c("zone2", "year", "week", "spp"),
                  rm_zone = "BC")

fc0 = abund_fc$grp %>%
  filter(zone == "FC")

abund = rbind(abund0$grp, fc0)
```



### 2 -------------------------------PCR & PLATEMAP CLEAN -----------------------------------------

DESC: - Reads in the pcr data from quantstudio that contains the Ct values\
- reads in platemap data that links the platmap postion with sample id\

DEPENDENCIES - tidyverse - readxl - purrr

INPUT - PCR: 1_input/pcr/\* \[dir_pcr\] - PLATEMAP: 1_input/platemap/\* \[dir_platemap\] - week_filter = 37 - year_filter = 2024 - copy_threshold = 500 - rn_threshold = 34000

OUTPUT - Cq combined pcr and platemap csv \[fn_cq_out = 2_mid/y##\_w##\_platemap.csv"\]

```{r}
#TO DO make a function
#source("../0_R/2_pcr_platemap_read_clean.R")

fn_path = list.files(path = dir_pcr, #
               full.names = T,
               ignore.case = T) 

cat("Reading in the PCR file: ", fn_path)

pcr_input = read_pcr(fn_path, sheet = "Results")

pcr_clean = clean_pcr(pcr_input,
                      y_pattern = "(?<=y)\\d+", #pattern from pcr filename that determines the year column
                      w_pattern = "(?<=w)\\d+", #pattern from pcr filename that determines the week column
                      p_pattern = "(?<=p)\\d+", #pattern from pcr filename that determines the plate column
                      undet_val = '55.55') #numeric value to replace "Undetermined" to ensure that the column is numeric without missing values (NA)

```


### 4 -------------------------------------- PCR PLOT --------------------------------------------

```{r pcr plot}
#TO DO make a function
source("../0_R/pcr_plot.R")
pcr_plot
```

Code Below:

-   data_input:
    -   active_traps.gsheet
    -   trap_malfunction.gsheet
-   data_output:
    -   fn_func_trap: data_mid/functional_traps.csv
-   description:
    -   pull and create list of functional traps (ones that are active that didn't malfunction)

```{r}
#source("0_R/get_func_trap.R")
#TO DO add in abundance calc from the ALL species

```

Code Below:

-   data_input:
    -   datasheets
    -   pcr_sheet
    -   platemap
    -   fn_func_trap: data_mid/functional_traps.csv \*to be added
-   data_output:
    -   fn_database_output
    -   unmatched traps
-   description:
    -   checks to ensure traps match existing list
    -   pulls database
    -   merges datasheet pcr and platemap data
    -   makes archive copy of database
    -   merges new data with database
    -   pushes changes from new data to database to googledrive

```{r}
source("0_R/data_merge_and_push.R")
```

Code Below: -data_input

```{r}
source("0_R/weekly_data_input.R")
```

Code Below:\
- data input:\
- data_input file and trap coordinates (if not in data_input)

```{r}
source("0_R/abundance_v2.R")
```

```{r}
source("0_R/pools.R")
```

Code Below:

Data Input:\
-output from abundance.R\
-data_input file:\
\
Data Output:\
-yYYYY_wWW_data_update\
\
Description:

\- calculates pooled Infection Rate and Vector Index\
-calculates all spp for each zone (TBD 24-07-16)

this script will drop weeks that only have a gravid trap. because gravid traps aren't used in abundance calculations

```{r}
source("0_R/pIR_VI.R")
```

```{r}
suppressMessages(
  source("0_R/historical_weekly.R")
)

p_hx_current
```

```{r}
source("0_R/tables.R")
```

Before generating tables and report make sure all the stuff is correct\

```{r}
#source("0_R/QC_report.R")
```

```{r}
suppressMessages(
  source("0_R/generate_report.R")
)
```
